<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Painel Simplificado - Picornavirus</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="hero">
      <div class="hero__content">
        <p class="eyebrow">WSL/Ubuntu • Alexsander Groth</p>
        <h1>PROGRAMA DE MESTRADO ACADÊMICO VIROLOGIA UNIVERSIDADE FEEVALE</h1>
        <p class="subtitle">Interface gráfica para executar pipeline, construir banco de dados viral e importar amostras.</p>
      </div>
      <div class="hero__logo">
        <img src="/feevale-logo.png" alt="Universidade Feevale" />
      </div>
    </header>

    <main>
      <div class="tabs">
        <button class="tab active" data-tab="tab-execucao">Execução</button>
        <button class="tab" data-tab="tab-configuracao">Configuração</button>
        <button class="tab" data-tab="tab-historico">Histórico</button>
      </div>

      <section id="tab-execucao" class="tab-panel active">
        <section class="card">
          <div class="card__header"><h2>1) Verificar ambiente</h2></div>
          <button class="primary" data-action="check_env">Rodar check de ambiente</button>
        </section>

        <section class="card">
          <div class="card__header"><h2>2) Gerar DEMO</h2></div>
          <button class="primary" data-action="demo">Gerar DEMO</button>
        </section>

        <section class="card">
          <div class="card__header">
            <h2>3) Baixar/Gerar DB viral (NCBI)</h2>
            <p>Sem hardcode de PTV. Escolha alvo no catálogo, com query ou taxid opcionais.</p>
            <div id="db-status" class="db-status">DB: nenhum selecionado</div>
          </div>
          <form id="db-form" class="form-grid">
            <label>Alvo
              <select id="db-target" name="target" required></select>
            </label>
            <label>Query customizada (opcional)
              <input name="query" placeholder='Ex.: "Teschovirus"[Organism] AND refseq[filter]' />
            </label>
            <label>TaxID (opcional)
              <input name="taxid" placeholder="Ex.: 12087" />
            </label>
            <button class="primary" type="submit">Baixar/Gerar DB</button>
          </form>
        </section>

        <section class="card">
          <div class="card__header">
            <h2>4) Importar amostras por caminho colado (R1/R2)</h2>
            <p>Aceita caminho Windows com normalização automática.</p>
          </div>
          <form id="import-form" class="form-grid">
            <label>Nome da amostra
              <input name="sample" list="samples" required />
            </label>
            <label>Caminho R1
              <input name="r1" placeholder="Ex.: C:\\dados\\amostra_R1.fastq.gz" required />
            </label>
            <label>Caminho R2
              <input name="r2" placeholder="Ex.: C:\\dados\\amostra_R2.fastq.gz" required />
            </label>
            <label class="checkbox"><input type="checkbox" name="copy" />Copiar arquivos (em vez de symlink)</label>
            <button class="primary" type="submit">Importar por caminho</button>
          </form>
          <datalist id="samples"></datalist>
        </section>

        <section class="card">
          <div class="card__header">
            <h2>5) Upload/importação (R1/R2 ou .zip)</h2>
          </div>
          <form id="upload-form" class="form-grid" enctype="multipart/form-data">
            <label>Nome da amostra
              <input name="sample" required />
            </label>
            <label>Arquivo R1 (opcional)
              <input name="r1file" type="file" accept=".fastq,.fastq.gz" />
            </label>
            <label>Arquivo R2 (opcional)
              <input name="r2file" type="file" accept=".fastq,.fastq.gz" />
            </label>
            <label>Arquivo .zip (opcional)
              <input name="zipfile" type="file" accept=".zip" />
            </label>
            <button class="primary" type="submit">Importar upload</button>
          </form>
        </section>

        <section class="card">
          <div class="card__header">
            <h2>6) Rodar pipeline</h2>
            <p>Selecione amostra já presente em <code>data/raw</code> (sem caminho completo).</p>
          </div>
          <form id="pipeline-form" class="form-grid">
            <label>Amostra
              <select id="sample-select" name="sample_select"></select>
              <input name="sample" placeholder="Ou informe manualmente" list="samples" />
            </label>
            <label>Assembler
              <select name="assembler">
                <option value="velvet">Velvet (padrão)</option>
                <option value="spades">SPAdes</option>
              </select>
            </label>
            <label>k-mer
              <input name="kmer" type="number" min="15" max="99" value="31" />
            </label>
            <button class="primary" type="submit">Executar pipeline</button>
          </form>
        </section>

        <section class="card">
          <div class="card__header"><h2>7) Saída e logs</h2></div>
          <div class="status">
            <div><span class="status__label">Status atual</span><strong id="job-status">Aguardando ação</strong></div>
            <div><span class="status__label">Última execução</span><strong id="job-action">-</strong></div>
          </div>
          <div class="pipeline-progress" id="pipeline-progress" hidden>
            <h3>Etapas do pipeline</h3>
            <ul>
              <li data-stage="host"><span class="stage-icon">⏳</span> Remoção de hospedeiro</li>
              <li data-stage="assembly"><span class="stage-icon">⏳</span> Montagem</li>
              <li data-stage="blast"><span class="stage-icon">⏳</span> BLAST</li>
            </ul>
          </div>
          <div id="final-status" class="final-status"></div>
          <pre id="job-output" class="log"></pre>
          <div class="report-viewer" id="report-viewer" hidden>
            <h3>Resumo do resultado</h3>
            <pre id="report-content" class="report-content"></pre>
          </div>
        </section>
      </section>

      <section id="tab-configuracao" class="tab-panel">
        <section class="card">
          <div class="card__header">
            <h2>Status do ambiente (environment.yml)</h2>
            <p>Informações sobre o ambiente Conda/micromamba do projeto.</p>
          </div>
          <div id="env-status" class="status">
            <div><span class="status__label">Arquivo</span><strong id="env-file-status">Carregando...</strong></div>
            <div><span class="status__label">Última modificação</span><strong id="env-mtime">-</strong></div>
            <div><span class="status__label">Caminho</span><strong id="env-path">-</strong></div>
          </div>
          <button class="primary" id="rebuild-env-btn">Recriar ambiente</button>
          <div id="rebuild-status" class="final-status"></div>
        </section>

        <section class="card">
          <div class="card__header">
            <h2>Configuração do pipeline</h2>
            <p>Edite as variáveis de configuração do arquivo <code>config/picornavirus.env</code>.</p>
          </div>
          <form id="config-form" class="form-grid">
            <label>ASSEMBLER
              <select name="ASSEMBLER">
                <option value="">Não definido</option>
                <option value="velvet">velvet</option>
                <option value="spades">spades</option>
              </select>
            </label>
            <label>VELVET_K
              <input name="VELVET_K" type="number" placeholder="Ex: 31" />
            </label>
            <label>THREADS
              <input name="THREADS" type="number" placeholder="Ex: 4" />
            </label>
            <label>DB
              <input name="DB" placeholder="Ex: ptv" />
            </label>
            <label>RAW_DIR
              <input name="RAW_DIR" placeholder="Ex: data/raw" />
            </label>
            <label>BLAST_DB
              <input name="BLAST_DB" placeholder="Ex: blastdb/ptv" />
            </label>
            <label>HOST_REMOVED_DIR
              <input name="HOST_REMOVED_DIR" placeholder="Ex: data/host_removed" />
            </label>
            <label>HOST_INDEX_PREFIX
              <input name="HOST_INDEX_PREFIX" placeholder="Ex: bowtie2/host" />
            </label>
            <label>SAMPLE_NAME
              <input name="SAMPLE_NAME" placeholder="Ex: amostra_teste" />
            </label>
            <label>SAMPLE_ID
              <input name="SAMPLE_ID" placeholder="Ex: amostra_teste" />
            </label>
            <button class="primary" type="submit">Salvar configuração</button>
          </form>
          <div id="config-status" class="final-status"></div>
        </section>
      </section>

      <section id="tab-historico" class="tab-panel">
        <section class="card">
          <div class="card__header"><h2>Histórico de execuções</h2></div>
          <div id="history-list" class="history-list"></div>
        </section>
      </section>
    </main>

    <script src="/app.js"></script>
  </body>
</html>
